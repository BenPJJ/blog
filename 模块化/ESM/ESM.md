# ESM

EcmaScript Module的缩写，是JavaScript 官方的标准化模块系统

## 原理

### 依赖关系图

当你在使用模块进行开发时，其实是在构建一张**依赖关系图**。不同模块之间的连线就代表了代码中的导入语句。

正是这些导入语句告诉浏览器或者Node 该去加载哪些代码

为依赖关系图指定一个入口文件，从这个入口文件开始，浏览器或Node 就会顺着导入语句找到所依赖的其他代码文件

![entry](img\entry.png)

### 模块记录

但是，浏览器并不能直接使用这些代码文件。需要解析所有的文件，并把它们变成一种称为**模块记录**

（Module Record）的数据结构。

![record](img\record.png)

#### 模板实例

解析之后，还需要把模块记录变成一个**模块实例**。模块实例会把**代码和状态**结合起来。

##### 代码

所谓代码，基本上是一组指令集合。它就像是制作某样东西的配方，指导你该如何制作。但是它本身并不能让你完成制作。你还需要一些原料，这样才可以按照这些指令完成制作。

##### 状态

所谓状态，它就是原料。具体点，状态是变量在任何时候的真实值。当然，变量实际上就是内存地址的别名，内存才是真正存储值得地方。

所以，可以看出，**模板实例中代码和状态的结合**，就是指令集合变量值得结合

![instance](img\instance.png)

对于模板而言，我们真正需要的是模板实例。模板加载会从入口文件开始，最终生成完整的模板实例关系图。

## ESM加载过程

对于ESM，这个过程包含三个阶段：

1. **构建：** 查找、下载，然后把所有文件解析成模块记录
2. **实例化：** 为所有模块分配内存空间（此刻还没有填充值），然后依照导出、导入语句把模块指向对应的内存地址。这个过程称为**链接**
3. **运行：** 运行代码，从而把内存空间填充为真实值

![construction](img\construction.png)

